from typing import List
import os
import numpy as np
import cv2
from game.game import Action, AbstractGame
import retro
import _pickle as cPickle
import time

def select_stage(env):
    null = np.array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],dtype='int8')
    down = np.array([0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],dtype='int8')
    start = np.array([0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],dtype='int8')    
    for x in range(18*50):
        _,_,_,_ = env.step(null)

    for x in range(5):
        _,_,_,_ = env.step(start)

    for x in range(150):
        _,_,_,_ = env.step(null)

    for x in range(5):
        _,_,_,_ = env.step(down)        

    for x in range(10):
        _,_,_,_ = env.step(start)

    for x in range(150):
        _,_,_,_ = env.step(null)

    for x in range(5):
        _,_,_,_ = env.step(down)

    for x in range(5):
        _,_,_,_ = env.step(start)

    for x in range(150):
        _,_,_,_ = env.step(null)


def select_fighters(env,player1_fighter, player2_fighter):
    fighter_dict = {'ryu' : [None,None,None,None],
                   'ehonda' : [7,None,None,None],
                   'blanka' : [7,7,None,None],
                   'guile' : [7,7,7,None],
                   'ken': [5,None,None,None],
                   'chunli' : [5,7,None,None],
                   'zangief' : [5,7,7,None],
                   'dhalsim' : [5,7,7,7]
                   }
    player1_movelist = fighter_dict[player1_fighter]
    player2_movelist = fighter_dict[player2_fighter]
    move = np.zeros(24,dtype='int8')
    move[4+12] = 1 
    for x in range(5):
        _,_,_,_ = env.step(move)

    for x in range(20):
        _,_,_,_ = env.step(np.zeros(24,dtype='int8'))
        
    for i in range(4):
        move = np.zeros(24,dtype='int8')
        if player1_movelist[i] != None:
            move[player1_movelist[i]] = 1
        if player2_movelist[i] != None:
            move[player2_movelist[i]+12] = 1            
        for x in range(5):
            _,_,_,_ = env.step(move)
    
        for x in range(20):
            _,_,_,_ = env.step(np.zeros(24,dtype='int8'))
    move = np.zeros(24,dtype='int8')   
    move[3] = 1
    move[12+3] = 1
    for x in range(5):
        _,_,_,_ = env.step(move)
    for x in range(150):
        _,_,_,_ = env.step(np.zeros(24,dtype='int8'))
    move = np.zeros(24,dtype='int8')   
    move[3] = 1                        
    for x in range(5):
        _,_,_,_ = env.step(move)
    for x in range(150):
        obs,_,_,info = env.step(np.zeros(24,dtype='int8'))
    return obs, info

def get_decoder(fighter):
    ryu_named_moves = {'noop':[
                            [0,0,0,0,0,0,0,0,0,0,0,0]
                                ],
                            'low_block':[
                            [0,0,0,0,0,1,1,0,0,0,0,0]
                                ],
                            'high_block':[
                            [0,0,0,0,0,0,1,0,0,0,0,0]
                                ]*3,
                            'jump':[
                            [0,0,0,0,1,0,0,0,0,0,0,0]
                                ]*3,
                            'forward_jump':[
                            [0,0,0,0,1,0,0,1,0,0,0,0]
                                ]*3,
                            'backward_jump':[
                            [0,0,0,0,1,0,1,0,0,0,0,0]   
                                ]*3,
                            'forward':[
                            [0,0,0,0,0,0,0,1,0,0,0,0]
                                ]*3,
                            'low_kick_hard':[
                            [0,0,0,0,0,1,0,0,1,0,0,0]
                                ],
                            'low_kick_medium':[
                            [1,0,0,0,0,1,0,0,0,0,0,0]
                                ],
                            'low_kick_light':[
                            [0,1,0,0,0,1,0,0,0,0,0,0]
                                ],
                            'high_kick_hard':[
                            [0,0,0,0,0,0,0,0,1,0,0,0]
                                ],
                            'high_kick_medium':[
                            [1,0,0,0,0,0,0,0,0,0,0,0]
                                ],
                            'high_kick_light':[
                            [0,1,0,0,0,0,0,0,0,0,0,0]
                                ],
                            'low_punch_hard':[
                            [0,0,0,0,0,1,0,0,0,0,0,1]
                                ],
                            'low_punch_medium':[
                            [0,0,0,0,0,1,0,0,0,1,0,0]
                                ],
                            'low_punch_light':[
                            [0,0,0,0,0,1,0,0,0,0,1,0]
                                ],
                            'high_punch_hard':[
                            [0,0,0,0,0,0,0,0,0,0,0,1]
                                ],
                            'high_punch_medium':[
                            [0,0,0,0,0,0,0,0,0,1,0,0]
                                ],
                            'high_punch_light':[
                            [0,0,0,0,0,0,0,0,0,0,1,0]
                                ],
                            'seoi_nage_backward':[
                            [0,0,0,0,0,0,1,0,0,0,0,1]
                                ],
                            'seoi_nage_forward':[
                            [0,0,0,0,0,0,0,1,0,0,0,1]
                                ],                            
                            'tomoe_nage_backward':[
                            [0,0,0,0,0,0,1,0,1,0,0,0]
                                ],
                            'tomoe_nage_forward':[
                            [0,0,0,0,0,0,0,1,1,0,0,0]
                                ],                             
                            'hadouken_hard':[
                            [0,0,0,0,0,1,0,0,0,0,0,0],
                            [0,0,0,0,0,1,0,1,0,0,0,0],
                            [0,0,0,0,0,0,0,1,0,0,0,1]
                                ],
                            'hadouken_medium':[
                            [0,0,0,0,0,1,0,0,0,0,0,0],
                            [0,0,0,0,0,1,0,1,0,0,0,0],
                            [0,0,0,0,0,0,0,1,0,1,0,0]
                                ],                            
                            'hadouken_light':[
                            [0,0,0,0,0,1,0,0,0,0,0,0],
                            [0,0,0,0,0,1,0,1,0,0,0,0],
                            [0,0,0,0,0,0,0,1,0,0,1,0]
                                ], 
                            'shoryuken_hard':[
                            [0,0,0,0,0,0,0,1,0,0,0,0],
                            [0,0,0,0,0,1,0,0,0,0,0,0],
                            [0,0,0,0,0,1,0,1,0,0,0,1]
                                ],                            
                            'shoryuken_medium':[
                            [0,0,0,0,0,0,0,1,0,0,0,0],
                            [0,0,0,0,0,1,0,0,0,0,0,0],
                            [0,0,0,0,0,1,0,1,0,1,0,0]
                                ],                             
                            'shoryuken_light':[
                            [0,0,0,0,0,0,0,1,0,0,0,0],
                            [0,0,0,0,0,1,0,0,0,0,0,0],
                            [0,0,0,0,0,1,0,1,0,0,1,0]
                                ],                             
                            'tatsumaki_senpuukyaku_hard':[
                            [0,0,0,0,0,1,0,0,0,0,0,0],
                            [0,0,0,0,0,1,1,0,0,0,0,0],
                            [0,0,0,0,0,0,1,0,1,0,0,0]
                                ],
                            'tatsumaki_senpuukyaku_medium':[
                            [0,0,0,0,0,1,0,0,0,0,0,0],
                            [0,0,0,0,0,1,1,0,0,0,0,0],
                            [1,0,0,0,0,0,1,0,0,0,0,0]
                                ],                            
                            'tatsumaki_senpuukyaku_light':[
                            [0,0,0,0,0,1,0,0,0,0,0,0],
                            [0,0,0,0,0,1,1,0,0,0,0,0],
                            [0,1,0,0,0,0,1,0,0,0,0,0]
                                ] 
                            }
    
    dhalsim_named_moves = {'noop':[
                            [0,0,0,0,0,0,0,0,0,0,0,0]
                                ],
                            'low_block':[
                            [0,0,0,0,0,1,1,0,0,0,0,0]
                                ],
                            'high_block':[
                            [0,0,0,0,0,0,1,0,0,0,0,0]
                                ]*3,
                            'jump':[
                            [0,0,0,0,1,0,0,0,0,0,0,0]
                                ]*3,
                            'forward_jump':[
                            [0,0,0,0,1,0,0,1,0,0,0,0]
                                ]*3,
                            'backward_jump':[
                            [0,0,0,0,1,0,1,0,0,0,0,0]  
                                ]*3,
                            'forward':[
                            [0,0,0,0,0,0,0,1,0,0,0,0]
                                ]*3,
                            'low_kick_hard':[
                            [0,0,0,0,0,1,0,0,1,0,0,0]
                                ],
                            'low_kick_medium':[
                            [1,0,0,0,0,1,0,0,0,0,0,0]
                                ],
                            'low_kick_light':[
                            [0,1,0,0,0,1,0,0,0,0,0,0]
                                ],
                            'high_kick_hard':[
                            [0,0,0,0,0,0,0,0,1,0,0,0]
                                ],
                            'high_kick_medium':[
                            [1,0,0,0,0,0,0,0,0,0,0,0]
                                ],
                            'high_kick_light':[
                            [0,1,0,0,0,0,0,0,0,0,0,0]
                                ],
                            'low_punch_hard':[
                            [0,0,0,0,0,1,0,0,0,0,0,1]
                                ],
                            'low_punch_medium':[
                            [0,0,0,0,0,1,0,0,0,1,0,0]
                                ],
                            'low_punch_light':[
                            [0,0,0,0,0,1,0,0,0,0,1,0]
                                ],
                            'high_punch_hard':[
                            [0,0,0,0,0,0,0,0,0,0,0,1]
                                ],
                            'high_punch_medium':[
                            [0,0,0,0,0,0,0,0,0,1,0,0]
                                ],
                            'high_punch_light':[
                            [0,0,0,0,0,0,0,0,0,0,1,0]
                                ],
                            'yoga_smash_backward':[
                            [0,0,0,0,0,0,1,0,0,1,0,0]
                                ],
                            'yoga_smash_forward':[
                            [0,0,0,0,0,0,0,1,0,1,0,0]
                                ],                            
                            'yoga_throw_backward':[
                            [0,0,0,0,0,0,1,0,0,0,0,1]
                                ],
                            'yoga_throw_forward':[
                            [0,0,0,0,0,0,0,1,0,0,0,1]
                                ],                             
                            'yoga_fire_hard':[
                            [0,0,0,0,0,1,0,0,0,0,0,0],
                            [0,0,0,0,0,1,0,1,0,0,0,0],
                            [0,0,0,0,0,0,0,1,0,0,0,1]
                                ],
                            'yoga_fire_medium':[
                            [0,0,0,0,0,1,0,0,0,0,0,0],
                            [0,0,0,0,0,1,0,1,0,0,0,0],
                            [0,0,0,0,0,0,0,1,0,1,0,0]
                                ],                            
                            'yoga_fire_light':[
                            [0,0,0,0,0,1,0,0,0,0,0,0],
                            [0,0,0,0,0,1,0,1,0,0,0,0],
                            [0,0,0,0,0,0,0,1,0,0,1,1]
                                ], 
                            'yoga_teleport_forward':[
                            [0,0,0,0,0,0,1,0,0,0,0,0],
                            [0,0,0,0,0,1,0,0,0,0,0,0],
                            [0,0,0,0,0,1,1,0,0,1,1,0]
                                ],                            
                            'yoga_teleport_backward':[
                            [0,0,0,0,0,0,0,1,0,0,0,0],
                            [0,0,0,0,0,1,0,0,0,0,0,0],
                            [0,0,0,0,0,1,0,1,0,1,1,0]
                                ],                             
                            'yoga_flame_hard':[
                            [0,0,0,0,0,0,1,0,0,0,0,0],
                            [0,0,0,0,0,1,1,0,0,0,0,0],
                            [0,0,0,0,0,1,0,0,0,0,0,0],
                            [0,0,0,0,0,1,0,1,0,0,0,0],
                            [0,0,0,0,0,0,0,1,0,0,0,1]
                                ],                             
                            'yoga_flame_medium':[
                            [0,0,0,0,0,0,1,0,0,0,0,0],
                            [0,0,0,0,0,1,1,0,0,0,0,0],
                            [0,0,0,0,0,1,0,0,0,0,0,0],
                            [0,0,0,0,0,1,0,1,0,0,0,0],
                            [0,0,0,0,0,0,0,1,0,1,0,0]
                                ],
                            'yoga_flame_light':[
                            [0,0,0,0,0,0,1,0,0,0,0,0],
                            [0,0,0,0,0,1,1,0,0,0,0,0],
                            [0,0,0,0,0,1,0,0,0,0,0,0],
                            [0,0,0,0,0,1,0,1,0,0,0,0],
                            [0,0,0,0,0,0,0,1,0,0,1,0]
                                ],
                            'yoga_teleport_backward_far':[
                            [0,0,0,0,0,0,0,1,0,0,0,0],
                            [0,0,0,0,0,1,0,0,0,0,0,0],
                            [1,1,0,0,0,1,0,1,1,0,0,0]
                                ],  
                            }    
    
    guile_named_moves = {'noop':[
                                [0,0,0,0,0,0,0,0,0,0,0,0]
                                ],
                            'low_block':[
                            [0,0,0,0,0,1,1,0,0,0,0,0]
                                ],
                            'hold_down_back_0.5sec':[
                            [0,0,0,0,0,1,1,0,0,0,0,0],
                                ]*7,                             
                            'hold_down_back_1sec':[
                            [0,0,0,0,0,1,1,0,0,0,0,0],
                                ]*13, 
                            'hold_down_back_2sec':[
                            [0,0,0,0,0,1,1,0,0,0,0,0],
                                ]*26,                             
                            'high_block':[
                            [0,0,0,0,0,0,1,0,0,0,0,0]
                                ]*3,
                            'hold_back_0.5sec':[
                            [0,0,0,0,0,0,1,0,0,0,0,0],
                                ]*7,  
                            'hold_back_1sec':[
                            [0,0,0,0,0,0,1,0,0,0,0,0],
                                ]*13,  
                            'hold_back_2sec':[
                            [0,0,0,0,0,0,1,0,0,0,0,0],
                                ]*26, 
                            'jump':[
                            [0,0,0,0,1,0,0,0,0,0,0,0]
                                ]*3,
                            'forward_jump':[
                            [0,0,0,0,1,0,0,1,0,0,0,0]
                                ]*3,
                            'backward_jump':[
                            [0,0,0,0,1,0,1,0,0,0,0,0]  
                                ]*3,
                            'forward':[
                            [0,0,0,0,0,0,0,1,0,0,0,0]
                                ]*3,
                            'low_kick_hard':[
                            [0,0,0,0,0,1,0,0,1,0,0,0]
                                ],
                            'low_kick_medium':[
                            [1,0,0,0,0,1,0,0,0,0,0,0]
                                ],
                            'low_kick_light':[
                            [0,1,0,0,0,1,0,0,0,0,0,0]
                                ],
                            'high_kick_hard':[
                            [0,0,0,0,0,0,0,0,1,0,0,0]
                                ],
                            'high_kick_medium':[
                            [1,0,0,0,0,0,0,0,0,0,0,0]
                                ],
                            'high_kick_light':[
                            [0,1,0,0,0,0,0,0,0,0,0,0]
                                ],
                            'low_punch_hard':[
                            [0,0,0,0,0,1,0,0,0,0,0,1]
                                ],
                            'low_punch_medium':[
                            [0,0,0,0,0,1,0,0,0,1,0,0]
                                ],
                            'low_punch_light':[
                            [0,0,0,0,0,1,0,0,0,0,1,0]
                                ],
                            'high_punch_hard':[
                            [0,0,0,0,0,0,0,0,0,0,0,1]
                                ],
                            'high_punch_medium':[
                            [0,0,0,0,0,0,0,0,0,1,0,0]
                                ],
                            'high_punch_light':[
                            [0,0,0,0,0,0,0,0,0,0,1,0]
                                ],
                            'judo_throw_backward':[
                            [0,0,0,0,0,0,1,0,0,1,0,0]
                                ],
                            'judo_throw_forward':[
                            [0,0,0,0,0,0,0,1,0,1,0,0]
                                ],                            
                            'dragon_suplex_backward':[
                            [0,0,0,0,0,0,1,0,0,0,0,1]
                                ],
                            'dragon_suplex_forward':[
                            [0,0,0,0,0,0,0,1,0,0,0,1]
                                ],                             
                            'knee_bazooka':[
                            [1,0,0,0,0,0,0,1,0,0,0,0]
                                ],
                            'reverse_spin_kick':[
                            [0,0,0,0,0,0,0,1,1,0,0,0]
                                ], 
                            'sonic_boom_light':[
                            [0,0,0,0,0,0,0,1,0,0,1,0]
                                ],                                     
                            'somersault_kick_hard':[
                            [0,0,0,0,1,0,0,0,1,0,0,0]
                                ], 
                            'somersault_kick_medium':[
                            [1,0,0,0,1,0,0,0,0,0,0,0]
                                ], 
                            'somersault_kick_light':[
                            [0,1,0,0,1,0,0,0,0,0,0,0]
                                ],                                     
                            }    
    
    chunli_named_moves = {'noop':[
                                [0,0,0,0,0,0,0,0,0,0,0,0]
                                ],
                            'low_block':[
                            [0,0,0,0,0,1,1,0,0,0,0,0]
                                ],
                            'hold_down_back_0.5sec':[
                            [0,0,0,0,0,1,1,0,0,0,0,0],
                                ]*7,                             
                            'hold_down_back_1sec':[
                            [0,0,0,0,0,1,1,0,0,0,0,0],
                                ]*13, 
                            'hold_down_back_2sec':[
                            [0,0,0,0,0,1,1,0,0,0,0,0],
                                ]*26,                             
                            'high_block':[
                            [0,0,0,0,0,0,1,0,0,0,0,0]
                                ]*3,
                            'jump':[
                            [0,0,0,0,1,0,0,0,0,0,0,0]
                                ]*3,
                            'forward_jump':[
                            [0,0,0,0,1,0,0,1,0,0,0,0]
                                ]*3,
                            'backward_jump':[
                            [0,0,0,0,1,0,1,0,0,0,0,0]   
                                ]*3,
                            'forward':[
                            [0,0,0,0,0,0,0,1,0,0,0,0]
                                ]*3,
                            'low_kick_hard':[
                            [0,0,0,0,0,1,0,0,1,0,0,0]
                                ],
                            'low_kick_medium':[
                            [1,0,0,0,0,1,0,0,0,0,0,0]
                                ],
                            'low_kick_light':[
                            [0,1,0,0,0,1,0,0,0,0,0,0]
                                ],
                            'high_kick_hard':[
                            [0,0,0,0,0,0,0,0,1,0,0,0]
                                ],
                            'high_kick_medium':[
                            [1,0,0,0,0,0,0,0,0,0,0,0]
                                ],
                            'high_kick_light':[
                            [0,1,0,0,0,0,0,0,0,0,0,0]
                                ],
                            'low_punch_hard':[
                            [0,0,0,0,0,1,0,0,0,0,0,1]
                                ],
                            'low_punch_medium':[
                            [0,0,0,0,0,1,0,0,0,1,0,0]
                                ],
                            'low_punch_light':[
                            [0,0,0,0,0,1,0,0,0,0,1,0]
                                ],
                            'high_punch_hard':[
                            [0,0,0,0,0,0,0,0,0,0,0,1]
                                ],
                            'high_punch_medium':[
                            [0,0,0,0,0,0,0,0,0,1,0,0]
                                ],
                            'high_punch_light':[
                            [0,0,0,0,0,0,0,0,0,0,1,0]
                                ],
                            'koshuu_tou_backward':[
                            [0,0,0,0,0,0,1,0,0,0,0,1]
                                ],
                            'koshuu_tou_forward':[
                            [0,0,0,0,0,0,0,1,0,0,0,1]
                                ],                            
                            'kouhou_kaiten_kyaku':[
                            [1,0,0,0,0,0,0,1,0,0,0,0]
                                ],
                            'kaku_kyaku_raku':[
                            [0,0,0,0,0,0,0,1,1,0,0,0]
                                ],                             
                            'spinning_bird_kick_hard':[
                            [0,0,0,0,1,0,0,0,1,0,0,0]
                                ], 
                            'spinning_bird_kick_medium':[
                            [1,0,0,0,1,0,0,0,0,0,0,0]
                                ], 
                            'spinning_bird_kick_light':[
                            [0,1,0,0,1,0,0,0,0,0,0,0]
                                ],                                     
                            'hyakuretsu_kyaku_hard':[
                            [0,0,0,0,0,0,0,0,1,0,0,0],
                            [0,0,0,0,0,0,0,0,0,0,0,0],
                                ]*6,                                    
                            'hyakuretsu_kyaku_medium':[
                            [1,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,0,0,0,0],
                                ]*6,                                     
                            'hyakuretsu_kyaku_light':[
                            [0,1,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,0,0,0,0],
                                ]*6,                                     
                            'kikouken_hard':[
                            [0,0,0,0,0,0,1,0,0,0,0,0],
                            [0,0,0,0,0,1,1,0,0,0,0,0],
                            [0,0,0,0,0,1,0,0,0,0,0,0],
                            [0,0,0,0,0,1,0,1,0,0,0,0],
                            [0,0,0,0,0,0,0,1,0,0,0,1]
                                ],                             
                            'kikouken_medium':[
                            [0,0,0,0,0,0,1,0,0,0,0,0],
                            [0,0,0,0,0,1,1,0,0,0,0,0],
                            [0,0,0,0,0,1,0,0,0,0,0,0],
                            [0,0,0,0,0,1,0,1,0,0,0,0],
                            [0,0,0,0,0,0,0,1,0,1,0,0]
                                ],
                            'kikouken_light':[
                            [0,0,0,0,0,0,1,0,0,0,0,0],
                            [0,0,0,0,0,1,1,0,0,0,0,0],
                            [0,0,0,0,0,1,0,0,0,0,0,0],
                            [0,0,0,0,0,1,0,1,0,0,0,0],
                            [0,0,0,0,0,0,0,1,0,0,1,0]
                                ],                                    
                            }    
    
    zangief_named_moves = {'noop':[
                                [0,0,0,0,0,0,0,0,0,0,0,0]
                                ],
                            'low_block':[
                            [0,0,0,0,0,1,1,0,0,0,0,0]
                                ],
                            'high_block':[
                            [0,0,0,0,0,0,1,0,0,0,0,0]
                                ]*3,
                            'jump':[
                            [0,0,0,0,1,0,0,0,0,0,0,0]
                                ]*3,
                            'forward_jump':[
                            [0,0,0,0,1,0,0,1,0,0,0,0]
                                ]*3,
                            'backward_jump':[
                            [0,0,0,0,1,0,1,0,0,0,0,0]   
                                ]*3,
                            'forward':[
                            [0,0,0,0,0,0,0,1,0,0,0,0]
                                ]*3,
                            'low_kick_hard':[
                            [0,0,0,0,0,1,0,0,1,0,0,0]
                                ],
                            'low_kick_medium':[
                            [1,0,0,0,0,1,0,0,0,0,0,0]
                                ],
                            'low_kick_light':[
                            [0,1,0,0,0,1,0,0,0,0,0,0]
                                ],
                            'high_kick_hard':[
                            [0,0,0,0,0,0,0,0,1,0,0,0]
                                ],
                            'high_kick_medium':[
                            [1,0,0,0,0,0,0,0,0,0,0,0]
                                ],
                            'high_kick_light':[
                            [0,1,0,0,0,0,0,0,0,0,0,0]
                                ],
                            'low_punch_forward_hard':[
                            [0,0,0,0,0,1,0,1,0,0,0,1]
                                ],
                            'low_punch_forward_medium':[
                            [0,0,0,0,0,1,0,1,0,1,0,0]
                                ],
                            'low_punch_light':[
                            [0,0,0,0,0,1,0,0,0,0,1,0]
                                ],
                            'low_punch_backward_hard':[
                            [0,0,0,0,0,1,1,0,0,0,0,1]
                                ],
                            'low_punch_backward_medium':[
                            [0,0,0,0,0,1,1,0,0,1,0,0]
                                ],                            
                            'high_punch_hard':[
                            [0,0,0,0,0,0,0,0,0,0,0,1]
                                ],
                            'high_punch_medium':[
                            [0,0,0,0,0,0,0,0,0,1,0,0]
                                ],
                            'high_punch_light':[
                            [0,0,0,0,0,0,0,0,0,0,1,0]
                                ],
                            'brain_buster_backward':[
                            [0,0,0,0,0,0,1,0,0,0,0,1]
                                ],
                            'brain_buster_forward':[
                            [0,0,0,0,0,0,0,1,0,0,0,1]
                                ],                            
                            'piledriver_backward':[
                            [0,0,0,0,0,0,1,0,0,0,1,0]
                                ],
                            'piledriver_forward':[
                            [0,0,0,0,0,0,0,1,0,0,1,0]
                                ], 
                            'german_suplex_backward':[
                            [1,0,0,0,0,0,1,0,0,0,0,0]
                                ],
                            'german_suplex_forward':[
                            [1,0,0,0,0,0,0,1,0,0,0,0]
                                ],                            
                            'thunder_fire_powerbomb_backward':[
                            [0,0,0,0,0,0,1,0,1,0,0,0]
                                ],
                            'thunder_fire_powerbomb_forward':[
                            [0,0,0,0,0,0,0,1,1,0,0,0]
                                ],                                    
                            'kuuchuu_headbutt':[
                            [0,0,0,0,1,0,0,0,0,0,0,1]
                                ],                                    
                            'double_lariat_forward':[
                            [0,0,0,0,0,0,0,1,0,1,1,0],
                               ] + [
                            [0,0,0,0,0,0,0,1,0,0,0,0],
                                ]*22, 
                            'quick_lariat_forward':[
                            [1,1,0,0,0,0,0,1,0,0,0,0],
                               ] + [
                            [0,0,0,0,0,0,0,1,0,0,0,0],
                                ]*14,                                      
                            'screw_piledriver':[
                            [0,0,0,0,0,0,0,1,0,0,0,0],
                            [0,0,0,0,0,1,0,1,0,0,0,0],
                            [0,0,0,0,0,1,0,0,0,0,0,0],
                            [0,0,0,0,0,1,1,0,0,0,0,0],
                            [0,0,0,0,0,0,1,0,0,0,0,0],
                            [0,0,0,0,1,0,1,0,0,0,0,1],
                            [0,0,0,0,1,0,0,0,0,0,0,0],
                            [0,0,0,0,1,0,0,1,0,0,0,0],
                            [0,0,0,0,0,0,0,1,0,0,0,1],
                                ],                             
                            'double_lariat':[
                            [0,0,0,0,0,0,0,1,0,1,1,0],
                                ] + [
                            [0,0,0,0,0,0,0,0,0,0,0,0],
                                ]*22, 
                            'quick_lariat':[
                            [1,1,0,0,0,0,0,1,0,0,0,0],
                               ] + [
                            [0,0,0,0,0,0,0,0,0,0,0,0],
                                ]*14, 
                            'double_lariat_backward':[
                            [0,0,0,0,0,0,0,1,0,1,1,0],
                                ] + [
                            [0,0,0,0,0,0,1,0,0,0,0,0],
                                ]*22, 
                            }
                                    
    ehonda_named_moves = {'noop':[
                            [0,0,0,0,0,0,0,0,0,0,0,0]
                            ],
                            'low_block':[
                            [0,0,0,0,0,1,1,0,0,0,0,0]
                                ],
                            'hold_down_back_0.5sec':[
                            [0,0,0,0,0,1,1,0,0,0,0,0],
                                ]*7,                             
                            'hold_down_back_1sec':[
                            [0,0,0,0,0,1,1,0,0,0,0,0],
                                ]*13, 
                            'hold_down_back_2sec':[
                            [0,0,0,0,0,1,1,0,0,0,0,0],
                                ]*26,                             
                            'high_block':[
                            [0,0,0,0,0,0,1,0,0,0,0,0]
                                ]*3,
                            'hold_back_0.5sec':[
                            [0,0,0,0,0,0,1,0,0,0,0,0],
                                ]*7,  
                            'hold_back_1sec':[
                            [0,0,0,0,0,0,1,0,0,0,0,0],
                                ]*13,  
                            'hold_back_2sec':[
                            [0,0,0,0,0,0,1,0,0,0,0,0],
                                ]*26, 
                            'jump':[
                            [0,0,0,0,1,0,0,0,0,0,0,0]
                                ]*3,
                            'forward_jump':[
                            [0,0,0,0,1,0,0,1,0,0,0,0]
                                ]*3,
                            'backward_jump':[
                            [0,0,0,0,1,0,1,0,0,0,0,0]  
                                ]*3,
                            'forward':[
                            [0,0,0,0,0,0,0,1,0,0,0,0]
                                ]*3,
                            'low_kick_hard':[
                            [0,0,0,0,0,1,0,0,1,0,0,0]
                                ],
                            'low_kick_medium':[
                            [1,0,0,0,0,1,0,0,0,0,0,0]
                                ],
                            'low_kick_light':[
                            [0,1,0,0,0,1,0,0,0,0,0,0]
                                ],
                            'high_kick_hard':[
                            [0,0,0,0,0,0,0,0,1,0,0,0]
                                ],
                            'high_kick_medium':[
                            [1,0,0,0,0,0,0,0,0,0,0,0]
                                ],
                            'high_kick_light':[
                            [0,1,0,0,0,0,0,0,0,0,0,0]
                                ],
                            'low_punch_hard':[
                            [0,0,0,0,0,1,0,0,0,0,0,1]
                                ],
                            'low_punch_medium':[
                            [0,0,0,0,0,1,0,0,0,1,0,0]
                                ],
                            'low_punch_light':[
                            [0,0,0,0,0,1,0,0,0,0,1,0]
                                ],
                            'high_punch_hard':[
                            [0,0,0,0,0,0,0,0,0,0,0,1]
                                ],
                            'high_punch_medium':[
                            [0,0,0,0,0,0,0,0,0,1,0,0]
                                ],
                            'high_punch_light':[
                            [0,0,0,0,0,0,0,0,0,0,1,0]
                                ],
                            'tawara_nage_backward':[
                            [0,0,0,0,0,0,1,0,0,1,0,0]
                                ],
                            'tawara_nage_forward':[
                            [0,0,0,0,0,0,0,1,0,1,0,0]
                                ],                            
                            'saba_ori':[
                            [0,0,0,0,0,0,1,0,0,0,0,1]
                                ],
                            'hiza_geri':[
                            [1,0,0,0,0,0,1,0,0,0,0,0]
                                ],                            
                            'sekkan_backward':[
                            [0,0,0,0,0,0,1,0,1,0,0,0]
                                ],                             
                            'super_sutsuki_hard':[
                            [0,0,0,0,0,0,0,1,0,0,0,1]
                                ], 
                            'super_sutsuki_light':[
                            [0,0,0,0,0,0,0,1,0,0,1,0]
                                ],                                     
                            'hyakuretsu_harite_hard':[
                            [0,0,0,0,0,0,0,0,0,0,0,1],
                            [0,0,0,0,0,0,0,0,0,0,0,0],
                                ]*6,                                    
                            'hyakuretsu_harite_medium':[
                            [0,0,0,0,0,0,0,0,0,1,0,0],
                            [0,0,0,0,0,0,0,0,0,0,0,0],
                                ]*6,                                     
                            'hyakuretsu_harite_light':[
                            [0,0,0,0,0,0,0,0,0,0,1,0],
                            [0,0,0,0,0,0,0,0,0,0,0,0],
                                ]*6,                                       
                            }  
                                    
    blanka_named_moves = {'noop':[
                            [0,0,0,0,0,0,0,0,0,0,0,0]
                            ],
                            'low_block':[
                            [0,0,0,0,0,1,1,0,0,0,0,0]
                                ],
                            'hold_down_back_0.5sec':[
                            [0,0,0,0,0,1,1,0,0,0,0,0],
                                ]*7,                             
                            'hold_down_back_1sec':[
                            [0,0,0,0,0,1,1,0,0,0,0,0],
                                ]*13, 
                            'hold_down_back_2sec':[
                            [0,0,0,0,0,1,1,0,0,0,0,0],
                                ]*26,                             
                            'high_block':[
                            [0,0,0,0,0,0,1,0,0,0,0,0]
                                ]*3,
                            'hold_back_0.5sec':[
                            [0,0,0,0,0,0,1,0,0,0,0,0],
                                ]*7,  
                            'hold_back_1sec':[
                            [0,0,0,0,0,0,1,0,0,0,0,0],
                                ]*13,  
                            'hold_back_2sec':[
                            [0,0,0,0,0,0,1,0,0,0,0,0],
                                ]*26,                               
                            'jump':[
                            [0,0,0,0,1,0,0,0,0,0,0,0]
                                ]*3,
                            'forward_jump':[
                            [0,0,0,0,1,0,0,1,0,0,0,0]
                                ]*3,
                            'backward_jump':[
                            [0,0,0,0,1,0,1,0,0,0,0,0]  
                                ]*3,
                            'forward':[
                            [0,0,0,0,0,0,0,1,0,0,0,0]
                                ]*3,
                            'low_kick_hard':[
                            [0,0,0,0,0,1,0,0,1,0,0,0]
                                ],
                            'low_kick_medium':[
                            [1,0,0,0,0,1,0,0,0,0,0,0]
                                ],
                            'low_kick_light':[
                            [0,1,0,0,0,1,0,0,0,0,0,0]
                                ],
                            'high_kick_hard':[
                            [0,0,0,0,0,0,0,0,1,0,0,0]
                                ],
                            'high_kick_medium':[
                            [1,0,0,0,0,0,0,0,0,0,0,0]
                                ],
                            'high_kick_light':[
                            [0,1,0,0,0,0,0,0,0,0,0,0]
                                ],
                            'low_punch_hard':[
                            [0,0,0,0,0,1,0,0,0,0,0,1]
                                ],
                            'low_punch_medium':[
                            [0,0,0,0,0,1,0,0,0,1,0,0]
                                ],
                            'low_punch_light':[
                            [0,0,0,0,0,1,0,0,0,0,1,0]
                                ],
                            'high_punch_hard':[
                            [0,0,0,0,0,0,0,0,0,0,0,1]
                                ],
                            'high_punch_medium':[
                            [0,0,0,0,0,0,0,0,0,1,0,0]
                                ],
                            'high_punch_light':[
                            [0,0,0,0,0,0,0,0,0,0,1,0]
                                ],
                            'rock_crush':[
                            [0,0,0,0,0,0,0,1,0,1,0,0]
                                ],                            
                            'wild_fang':[
                            [0,0,0,0,0,0,1,0,0,0,0,1]
                                ],
                            'rolling_attack_hard':[
                            [0,0,0,0,0,0,0,1,0,0,0,1]
                                ], 
                            'rolling_attacklight':[
                            [0,0,0,0,0,0,0,1,0,0,1,0]
                                ],                                     
                            'vertical_rolling_hard':[
                            [0,0,0,0,1,0,0,0,1,0,0,0]
                                ], 
                            'vertical_rolling_medium':[
                            [1,0,0,0,1,0,0,0,0,0,0,0]
                                ], 
                            'vertical_rolling_light':[
                            [0,1,0,0,1,0,0,0,0,0,0,0]
                                ],                                     
                            'electric_thunder_hard':[
                            [0,0,0,0,0,0,0,0,0,0,0,1],
                            [0,0,0,0,0,0,0,0,0,0,0,0],
                                ]*6,                                    
                            'electric_thunder_medium':[
                            [0,0,0,0,0,0,0,0,0,1,0,0],
                            [0,0,0,0,0,0,0,0,0,0,0,0],
                                ]*6,                                     
                            'electric_thunder_light':[
                            [0,0,0,0,0,0,0,0,0,0,1,0],
                            [0,0,0,0,0,0,0,0,0,0,0,0],
                                ]*6,                                       
                            }
    ken_named_moves = {'noop':[
                            [0,0,0,0,0,0,0,0,0,0,0,0]
                                ],
                            'low_block':[
                            [0,0,0,0,0,1,1,0,0,0,0,0]
                                ],
                            'high_block':[
                            [0,0,0,0,0,0,1,0,0,0,0,0]
                                ]*3,
                            'jump':[
                            [0,0,0,0,1,0,0,0,0,0,0,0]
                                ]*3,
                            'forward_jump':[
                            [0,0,0,0,1,0,0,1,0,0,0,0]
                                ]*3,
                            'backward_jump':[
                            [0,0,0,0,1,0,1,0,0,0,0,0]   
                                ]*3,
                            'forward':[
                            [0,0,0,0,0,0,0,1,0,0,0,0]
                                ]*3,
                            'low_kick_hard':[
                            [0,0,0,0,0,1,0,0,1,0,0,0]
                                ],
                            'low_kick_medium':[
                            [1,0,0,0,0,1,0,0,0,0,0,0]
                                ],
                            'low_kick_light':[
                            [0,1,0,0,0,1,0,0,0,0,0,0]
                                ],
                            'high_kick_hard':[
                            [0,0,0,0,0,0,0,0,1,0,0,0]
                                ],
                            'high_kick_medium':[
                            [1,0,0,0,0,0,0,0,0,0,0,0]
                                ],
                            'high_kick_light':[
                            [0,1,0,0,0,0,0,0,0,0,0,0]
                                ],
                            'low_punch_hard':[
                            [0,0,0,0,0,1,0,0,0,0,0,1]
                                ],
                            'low_punch_medium':[
                            [0,0,0,0,0,1,0,0,0,1,0,0]
                                ],
                            'low_punch_light':[
                            [0,0,0,0,0,1,0,0,0,0,1,0]
                                ],
                            'high_punch_hard':[
                            [0,0,0,0,0,0,0,0,0,0,0,1]
                                ],
                            'high_punch_medium':[
                            [0,0,0,0,0,0,0,0,0,1,0,0]
                                ],
                            'high_punch_light':[
                            [0,0,0,0,0,0,0,0,0,0,1,0]
                                ],
                            'seoi_nage_backward':[
                            [0,0,0,0,0,0,1,0,0,0,0,1]
                                ],
                            'seoi_nage_forward':[
                            [0,0,0,0,0,0,0,1,0,0,0,1]
                                ],                            
                            'tomoe_nage_backward':[
                            [0,0,0,0,0,0,1,0,1,0,0,0]
                                ],
                            'tomoe_nage_forward':[
                            [0,0,0,0,0,0,0,1,1,0,0,0]
                                ],                             
                            'hadouken_hard':[
                            [0,0,0,0,0,1,0,0,0,0,0,0],
                            [0,0,0,0,0,1,0,1,0,0,0,0],
                            [0,0,0,0,0,0,0,1,0,0,0,1]
                                ],
                            'hadouken_medium':[
                            [0,0,0,0,0,1,0,0,0,0,0,0],
                            [0,0,0,0,0,1,0,1,0,0,0,0],
                            [0,0,0,0,0,0,0,1,0,1,0,0]
                                ],                            
                            'hadouken_light':[
                            [0,0,0,0,0,1,0,0,0,0,0,0],
                            [0,0,0,0,0,1,0,1,0,0,0,0],
                            [0,0,0,0,0,0,0,1,0,0,1,0]
                                ], 
                            'shoryuken_hard':[
                            [0,0,0,0,0,0,0,1,0,0,0,0],
                            [0,0,0,0,0,1,0,0,0,0,0,0],
                            [0,0,0,0,0,1,0,1,0,0,0,1]
                                ],                            
                            'shoryuken_medium':[
                            [0,0,0,0,0,0,0,1,0,0,0,0],
                            [0,0,0,0,0,1,0,0,0,0,0,0],
                            [0,0,0,0,0,1,0,1,0,1,0,0]
                                ],                             
                            'shoryuken_light':[
                            [0,0,0,0,0,0,0,1,0,0,0,0],
                            [0,0,0,0,0,1,0,0,0,0,0,0],
                            [0,0,0,0,0,1,0,1,0,0,1,0]
                                ],                             
                            'tatsumaki_senpuukyaku_hard':[
                            [0,0,0,0,0,1,0,0,0,0,0,0],
                            [0,0,0,0,0,1,1,0,0,0,0,0],
                            [0,0,0,0,0,0,1,0,1,0,0,0]
                                ],
                            'tatsumaki_senpuukyaku_medium':[
                            [0,0,0,0,0,1,0,0,0,0,0,0],
                            [0,0,0,0,0,1,1,0,0,0,0,0],
                            [1,0,0,0,0,0,1,0,0,0,0,0]
                                ],                            
                            'tatsumaki_senpuukyaku_light':[
                            [0,0,0,0,0,1,0,0,0,0,0,0],
                            [0,0,0,0,0,1,1,0,0,0,0,0],
                            [0,1,0,0,0,0,1,0,0,0,0,0]
                                ] 
                            }
    
    max_moves=36
    if fighter == 'ryu':
        return list(ryu_named_moves.keys()) + ['noop']*(max_moves-len(ryu_named_moves)), ryu_named_moves
    if fighter == 'dhalsim':
        return list(dhalsim_named_moves.keys()) + ['noop']*(max_moves-len(dhalsim_named_moves)), dhalsim_named_moves
    if fighter == 'guile':
        return list(guile_named_moves.keys()) + ['noop']*(max_moves-len(guile_named_moves)), guile_named_moves
    if fighter == 'chunli':
        return list(chunli_named_moves.keys()) + ['noop']*(max_moves-len(chunli_named_moves)), chunli_named_moves
    if fighter == 'ehonda':
        return list(ehonda_named_moves.keys()) + ['noop']*(max_moves-len(ehonda_named_moves)), ehonda_named_moves
    if fighter == 'blanka':
        return list(blanka_named_moves.keys()) + ['noop']*(max_moves-len(blanka_named_moves)), blanka_named_moves
    if fighter == 'ken':
        return list(ken_named_moves.keys()) + ['noop']*(max_moves-len(ken_named_moves)), ken_named_moves
    if fighter == 'zangief':
        return list(zangief_named_moves.keys()) + ['noop']*(max_moves-len(zangief_named_moves)), zangief_named_moves



class StreetFighter2(AbstractGame):
    """The Gym CartPole environment"""

    def __init__(self, discount: float, memory_path: str):
        super().__init__(discount)
        self.fighters = ['ryu','ehonda','blanka','guile',
            'ken','chunli','zangief','dhalsim']
        self.matchups = [('zangief','ehonda',),('ryu','guile',),('ken','dhalsim',),('blanka','chunli')]
        self.matchups = [('zangief','ehonda',)]
        chosen_fighters = np.random.choice(np.arange(len(self.matchups)))
        self.player1 = self.matchups[chosen_fighters][0]
        self.player2 = self.matchups[chosen_fighters][1]
        self.env = retro.make('StreetFighterIISpecialChampionEdition-Genesis',players=2,use_restricted_actions=retro.Actions.ALL)
        self.obs_shape = (96,96,3)
        _ = self.env.reset()
        select_stage(self.env)
        initial_obs, initial_info = select_fighters(self.env,self.player1,self.player2)
        self.gif_images = [initial_obs]
        self.initial_obs = np.transpose(np.array([cv2.resize(i, (self.obs_shape[1],self.obs_shape[0]), interpolation=cv2.INTER_AREA) for i in np.transpose(initial_obs, (2,0,1))]),(1,2,0))
        self.observations = [self.initial_obs]
        self.steps = 2
        self.done = False
        self.render_steps = False
        self.prev_obs = 15
        self.memory_path = memory_path
        self.player1_health = initial_info['health']
        self.player2_health = initial_info['enemy_health']
        self.player1_matches = initial_info['matches_won']
        self.player2_matches = initial_info['enemy_matches_won']
        self.player1_x_pos = initial_info['x_position']
        self.player2_x_pos = initial_info['enemy_x_position']
        self.x_pos_dif = [abs(initial_info['x_position'] - initial_info['enemy_x_position'])]

        self.player1_discrete_action_decoder, self.player1_named_moves = get_decoder(self.player1)
        self.player2_discrete_action_decoder, self.player2_named_moves = get_decoder(self.player2)

        self.actions = list(map(lambda i: Action(i), range(len(self.player1_discrete_action_decoder)))) # len 35
        self.player1_ready = False
        self.player2_ready = False
        self.player1_current_move = []
        self.player2_current_move = []
        self.player1_historic_network = False
        self.player2_historic_network = False
        self.player1_jump = False
        self.player2_jump = False
        self.player1_jump_ready = False
        self.player2_jump_ready = False
        self.player1_status_history = []
        self.player2_status_history = []
    
    @property
    def action_space_size(self) -> int:
        """Return the size of the action space."""
        return len(self.actions)

    def execute_actions(self, player1_action, player2_action, render=False) -> int:
        """Execute one step of the game conditioned by the given action."""
        obs = []
        if len(self.player1_current_move) > 0:
            player1_action_array = np.array(self.player1_current_move.pop(0))
        else:
            self.player1_current_move = self.player1_named_moves[self.player1_discrete_action_decoder[player1_action.index]].copy()
            player1_action_array = np.array(self.player1_current_move.pop(0))
        if len(self.player2_current_move) > 0:
            player2_action_array = np.array(self.player2_current_move.pop(0))
        else:
            self.player2_current_move = self.player2_named_moves[self.player2_discrete_action_decoder[player2_action.index]].copy()
            player2_action_array = np.array(self.player2_current_move.pop(0))  
        if self.player1_x_pos > self.player2_x_pos:
            if player1_action_array[7] == 1:
                player1_action_array[7] = 0
                player1_action_array[6] = 1
            elif player1_action_array[6] == 1:
                player1_action_array[6] = 0
                player1_action_array[7] = 1 
            direction = 'left'
        if self.player2_x_pos > self.player1_x_pos:
            if player2_action_array[7] == 1:
                player2_action_array[7] = 0
                player2_action_array[6] = 1
            elif player2_action_array[6] == 1:
                player2_action_array[6] = 0
                player2_action_array[7] = 1     
            direction = 'right'
        if self.player2_x_pos == self.player1_x_pos:
            direction = 'same'
        # Execute {steps} frames and accumulate the reward
        for i in range(self.steps):

            state_frame, _, done, info = self.env.step(np.concatenate((player1_action_array,player2_action_array), axis=0))
            obs.append(state_frame)

            if done:
                break
        self.gif_images.append(obs[0])
        self.observations.append(np.transpose(np.array([cv2.resize(i, (self.obs_shape[1],self.obs_shape[0]), interpolation=cv2.INTER_AREA) for i in np.transpose(obs[0], (2,0,1))]),(1,2,0)))
        self.done = done
            
        if any([info['status'] in [0,1024], info['enemy_status'] in [0,1024],info['round_timer'] == 39208]):
            self.player1_ready = False
            self.player2_ready = False
        else:

            if (info['status'] == 516) & (self.player1_jump == False):
                self.player1_jump = True
                self.player1_jump_ready = True
            elif (info['status'] != 516) & (self.player1_jump == True):
                self.player1_jump = False
                self.player1_jump_ready = False
    
            if (info['enemy_status'] == 516) & (self.player2_jump == False):
                self.player2_jump = True
                self.player2_jump_ready = True
            elif (info['enemy_status'] != 516) & (self.player2_jump == True):
                self.player2_jump = False
                self.player2_jump_ready = False
    
            if len(self.player1_current_move) > 0:
                self.player1_ready = False
            elif info['status'] in [512,514,520]:
                self.player1_ready = True
            elif self.player1_jump == True:
                if self.player1_jump_ready == True:
                    if player1_action.index > 6:
                        self.player1_jump_ready = False
                    else:
                        self.player1_ready = True
                else:
                    self.player1_ready = False
            else:
                self.player1_ready = False
                
            if len(self.player2_current_move) > 0:
                self.player2_ready = False                
            elif info['enemy_status'] in [512,514,520]:
                self.player2_ready = True
            elif self.player2_jump == True:
                if self.player2_jump_ready == True:
                    if player2_action.index > 6:
                        self.player2_jump_ready = False
                    else:
                        self.player2_ready = True
                else:
                    self.player2_ready = False
            else:
                self.player2_ready = False

        player1_action_reward = info['health'] - self.player1_health
        player1_action_reward += self.player2_health - info['enemy_health']
        player1_action_reward += (info['matches_won'] - self.player1_matches) * 100
        if info['matches_won'] - self.player1_matches > 0:
            self.winner = self.player1
        player1_action_reward += (self.player2_matches - info['enemy_matches_won']) * 100
        if info['enemy_matches_won'] - self.player2_matches > 0:
            self.winner = self.player2
        player2_action_reward = -player1_action_reward
        if self.player1_x_pos - info['x_position'] == 0:
            player1_action_reward += -0.05        
        if self.player2_x_pos - info['enemy_x_position'] == 0:
            player2_action_reward += -0.05
        if direction == 'right':
            player1_action_reward += (info['x_position'] - self.player1_x_pos)/7
            player2_action_reward += (self.player2_x_pos - info['enemy_x_position'])/7
        if direction == 'left':
            player1_action_reward += (self.player1_x_pos - info['x_position'])/7
            player2_action_reward += (info['enemy_x_position'] - self.player2_x_pos)/7
        self.player1_health = info['health']
        self.player2_health = info['enemy_health']
        self.player1_matches = info['matches_won']
        self.player2_matches = info['enemy_matches_won']
        self.player1_x_pos = info['x_position']
        self.player2_x_pos = info['enemy_x_position']
        self.x_pos_dif.append(abs(info['x_position'] - info['enemy_x_position']))
#        self.player1_status_history.append(info['status'])
#        self.player2_status_history.append(info['enemy_status'])
        return [player1_action_reward/4,player2_action_reward/4] 

    def close(self):
        self.env.close()

    def terminal(self) -> bool:
        """Is the game is finished?"""
        return self.done

    def legal_actions(self) -> List[Action]:
        """Return the legal actions available at this instant."""
        return self.actions

    def make_image(self, state_index: int, player: str):
        """Compute the state of the game."""
        if state_index == -1:
            state_index = len(self.observations) - 1
        planes_per_obs = self.obs_shape[2] + 1
        state = np.zeros((*self.obs_shape[:2], (self.prev_obs + 1) * planes_per_obs)).astype('uint8')
        prev_obs_idx = np.arange(state_index - self.prev_obs, state_index)
        if state_index > 0:
            for i in range(self.prev_obs):
                if prev_obs_idx[i] < 0:
                    continue
                else:
                    state[:,:,planes_per_obs*i:planes_per_obs*i+planes_per_obs - 1] = self.observations[prev_obs_idx[i]] 
                    action_pattern_base_shape = int(np.floor(len(self.actions)**0.5) + 1)
                    action_pattern = np.zeros((action_pattern_base_shape**2))
                    if player == 'player1':
                        action_pattern[:self.history[prev_obs_idx[i]][0].index] = 255
                    if player == 'player2':
                        action_pattern[:self.history[prev_obs_idx[i]][1].index] = 255
                    action_pattern = action_pattern.reshape((action_pattern_base_shape,action_pattern_base_shape))
                    action_pattern = np.tile(action_pattern, ((state.shape[0]//action_pattern_base_shape,state.shape[1]//action_pattern_base_shape)))
                    action_pattern = np.pad(action_pattern, ((0,state.shape[0] % action_pattern_base_shape),(0,state.shape[1] % action_pattern_base_shape)))
                    state[:,:,planes_per_obs*i+planes_per_obs - 1] = action_pattern
        state[:,:,-self.obs_shape[2]-1:-1] = self.observations[state_index] 
        if player == 'player1':
            if len([i[0].index for i in self.history[state_index-25:state_index+1] if i[0].index in [1,2,3,4]]) > 25:
                state[:,:,-1] = 255
            elif len([i[0].index for i in self.history[state_index-25:state_index+1] if i[0].index in [1,2,3,4,5,6,7,8]]) > 25:
                state[:,:,-1] = 127
        if player == 'player2':
            if len([i[1].index for i in self.history[state_index-25:state_index+1] if i[1].index in [1,2,3,4]]) > 25:
                state[:,:,-1] = 255
            elif len([i[1].index for i in self.history[state_index-25:state_index+1] if i[1].index in [1,2,3,4,5,6,7,8]]) > 25:
                state[:,:,-1] = 127
        return state[:,:,-64:].astype('float32') / 255

    def step(self, action) -> int:
        """Execute one step of the game conditioned by the given action."""
        pass
    
    def save_gif(self,image_name: str):
        from PIL import Image, ImageDraw, ImageFont
        import win32api
        font = win32api.GetWindowsDirectory() + "\\Fonts\\ARIALBD.TTF"
        font = ImageFont.truetype(font, 15)
        gif = []
        for i in range(len(self.gif_images)):
            img = Image.fromarray(self.gif_images[i],'RGB')
            draw = ImageDraw.Draw(img)
            if i < len(self.gif_images) -1 :
                player1_value = round(self.root_values[i][0],2)
                if player1_value > 2:
                    player1_color = (0,255,0)
                elif player1_value > 0:
                    player1_color = (170,255,0)                    
                elif player1_value > -2:
                    player1_color = (255,170,0) 
                else:
                    player1_color = (255,0,0)
                player2_value = round(self.root_values[i][1],2)
                if player2_value > 2:
                    player2_color = (0,255,0)
                elif player2_value > 0:
                    player2_color = (170,255,0)                    
                elif player2_value > -2:
                    player2_color = (255,170,0) 
                else:
                    player2_color = (255,0,0)               
                
                p1_x, p1_y = 10, 180
                p2_x = 180
                
                draw.text((p1_x-1, p1_y-1), str(player1_value), font=font, fill='black')
                draw.text((p1_x+1, p1_y-1), str(player1_value), font=font, fill='black')
                draw.text((p1_x-1, p1_y+1), str(player1_value), font=font, fill='black')
                draw.text((p1_x+1, p1_y+1), str(player1_value), font=font, fill='black')

                draw.text((p2_x-1, p1_y-1), str(player2_value), font=font, fill='black')
                draw.text((p2_x+1, p1_y-1), str(player2_value), font=font, fill='black')
                draw.text((p2_x-1, p1_y+1), str(player2_value), font=font, fill='black')
                draw.text((p2_x-1, p1_y+1), str(player2_value), font=font, fill='black')                                
                
                draw.text((p1_x,p1_y),str(player1_value),player1_color, font=font)
                draw.text((p2_x,p1_y),str(player2_value),player2_color, font=font)
            gif += [img]
            
        gif[0].save(os.path.join(self.memory_path+'Gifs',image_name+'.gif'),
                       save_all=True,
                       append_images=gif[1:],
                       duration=1,
                       loop=0)
    def save_game_to_file(self, game_name):
        with open(os.path.join(self.memory_path,game_name), 'wb') as game_file:
            cPickle.dump(self, game_file)         